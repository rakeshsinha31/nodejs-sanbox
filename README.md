# Introduction

The candidate must demonstrate the use of the following technologies and concepts:

- `Typescript`. The codebase must be written primarily in `Typescript`.
- `Unit/Integration Tests`. `Unit/Integration Tests` must be written and must achieve a reasonable amount of coverage.
- `async/await`. The use of `callbacks` for asynchronous operations is highly discouraged. The candidate must use `Promises` and the `async/await` syntax whenever appropriate.
- `GraphQL`. The application must expose a `GraphQL` API.
- `Microservices Architecture`. The application must be broken down into multiple independent microservices.
- `RabbitMQ`. The microservice must be able to communicate with each other via `RabbitMQ`.
- `Docker`. Each microservice must run as a `Docker` container. A `compose file` that will start all microservices must be provided.
- `CQRS`. The `Command` and `Query` side of each service must be separated. The `Command` operations must use a separate model differement from the one used in the `Query` operations.
- `Event Sourcing`. The primary source of truth must be the sequence of events generated by all write operations. The `Application State` is only secondary and must be derived from the sequence of events.
- `MongoDB`. The candidate must use `MongoDB` as the primary database.

## Instructions

1. Clone the repository. `git@github.com:Proto-Garage/nodejs-sandbox.git`
2. Push the local copy to a private repository under your github account.
3. Add `djansyle` and `rogermadjos` as collaborators to the private repository.
4. Push your commits to the private repository. Follow `Angular's` [commit guidelines](https://github.com/angular/angular/blob/master/CONTRIBUTING.md#commit).

# Types

```typescript
type AccountRole = "ADMIN" | "VENDOR" | "CUSTOMER";
type DepositRequestStatus = "PENDING" | "APPROVED" | "REJECTED";
type WithdrawalRequestStatus = "PENDING" | "APPROVED" | "REJECTED";

type Account = {
  id: string;
  role: AccountRole;
  username: string;
  firstName: string;
  lastName: string;
};

type BalanceTransaction = {
  id: string;
  serialCode: string;
  delta: number;
  balance: number;
  source: "DEPOSIT" | "WITHDRAW" | "PLACE_BET" | "SETTLE_BET";
  dateTimeProcessed: string;
};

type BetRecord = {
  id: string;
  serialCode: string;
  gameRound: string;
  turnover: string;
  payout?: string;
  winloss?: string;
  status: "SETTLED" | "UNSETTLED";
  dateTimeStarted: string;
  dateTimeEnded?: string;
};

type DepositRequest = {
  id: string;
  account: string;
  serialCode: string;
  amount: number;
  status: DepositRequestStatus;
  dateTimeProcessed?: string;
};

type WithdrawalRequest = {
  id: string;
  account: string;
  serialCode: string;
  amount: number;
  status: WithdrawalRequestStatus;
  dateTimeProcessed?: string;
};

type Connection<T> = {
  totalCount: number;
  edges: {
    node: T;
    cursor: string;
  }[];
  pageInfo: {
    endCursor: string;
    hasNextPage: boolean;
  };
};
```

# Microservices

## Account

This service is responsible for handling/managing the account information.

### API

#### Command

- `CreateAccount`

  ```typescript
  type CreateAccount = (
    id: string,
    params: {
      role: AccountRole;
      username: string;
      password: string;
      firstName?: string;
      lastName?: string;
    }
  ) => Promise<void>;
  ```

- `UpdateAccount`

  ```typescript
  type UpdateAccount = (
    id: string,
    params: { password?: string; firstName?: string; lastName?: string }
  ) => Promise<void>;
  ```

#### Query

- `Account`

  ```typescript
  type Account = (id: string) => Promise<Account | null>;
  ```

- `Accounts`

  ```typescript
  type Accounts = (
    first?: number,
    after?: string,
    filter?: {
      role?: AccountRole;
    }
  ) => Promise<Connection<Account>>;
  ```

- `Authenticate`

  ```typescript
  type Authenticate = (username: string, password: string) => Promise<string>;
  ```

## Balance

This service is responsible for handling/managing account balances.

### API

#### Command

- `UpdateBalance`

  ```typescript
  type UpdateBalance = (params: {
    account: string;
    delta: number;
    source: "DEPOSIT" | "WITHDRAWAL" | "PLACE_BET" | "SETTLE_BET";
  }) => Promise<void>;
  ```

#### Query

- `Balance`

  ```typescript
  type Balance = (account: string) => Promise<number>;
  ```

- `BalanceTransactions`

  ```typescript
  type BalanceTransactions = (
    first?: number,
    after?: string,
    fitler?: { account?: string }
  ) => Promise<Connection<BalanceTransaction>>;
  ```

## Vendor

This service is responsible for handling/managing bet records.

### API

#### Command

- `PlaceBet`

  ```typescript
  type PlaceBet = (params: {
    account: string;
    gameRound: string;
    amount: number;
  }) => Promise<void>;
  ```

- `PayOut`

  ```typescript
  type PayOut = (params: {
    account: string;
    gameRound: string;
    amount: number;
  }) => Promise<void>;
  ```

- `EndGameRound`

  ```typescript
  type EndGameRound = (params: {
    account: string;
    gameRound: string;
  }) => Promise<void>;
  ```

#### Query

- `BetRecords`

  ```typescript
  type BetRecords = (
    first?: number,
    after?: string,
    fitler?: { account?: string }
  ) => Promise<Connection<BetRecord>>;
  ```

## Payment

This service is responsible for handling/managing deposits and withdrawals.

### API

#### Command

- `CreateDepositRequest`

  ```typescript
  type CreateDepositRequest = (
    id: string,
    params: {
      account: string;
      amount: number;
    }
  ) => Promise<void>;
  ```

- `CreateWithdrawalRequest`

  ```typescript
  type CreateWithdrawalRequest = (
    id: string,
    params: {
      account: string;
      amount: number;
    }
  ) => Promise<void>;
  ```

- `ApproveDepositRequest`

  ```typescript
  type ApproveDepositRequest = (id: string) => Promise<void>;
  ```

- `RejectDepositRequest`

  ```typescript
  type RejectDepositRequest = (id: string) => Promise<void>;
  ```

- `ApproveWithdrawalRequest`

  ```typescript
  type ApproveWithdrawalRequest = (id: string) => Promise<void>;
  ```

- `RejectWithdrawalRequest`

  ```typescript
  type RejectWithdrawalRequest = (id: string) => Promise<void>;
  ```

#### Query

- `DepositRequests`

  ```typescript
  type DepositRequests = (
    first?: number,
    after?: string,
    fitler?: { account?: string; status?: DepositRequestStatus }
  ) => Promise<Connection<DepositRequest>>;
  ```

- `WithdrawalRequests`

  ```typescript
  type WithdrawalRequests = (
    first?: number,
    after?: string,
    fitler?: { account?: string; status?: WithdrawalRequestStatus }
  ) => Promise<Connection<WithdrawalRequest>>;
  ```

## API

This service is responsible for exposing the `GraphQL` API and for providing an `HTTP` API for authentication.

### GraphQL

The schema defined in `schema.gql` must be implemented. To authorize the requests, the `Authorization` header must be set as follows:

```
Authorization: Bearer ${accessToken}
```

The `accessToken` is generated via the `Authentication` API. An optional `X-Request-ID` header must also be supported. The request is idempotent for all request instances with the same `X-Request-ID`.

### Authentication

Please refer to [Authentication](https://www.notion.so/highoutput/Authentication-ea43c7db07814a1ebac66dba07139f78). For the purposes of this sandbox project, please ignore the `AdminCode` header.
